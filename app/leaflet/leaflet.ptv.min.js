/*! leaflet.ptv 2016-02-24 */
L.PtvLayer=L.PtvLayer||{},L.PtvLayer.AbstractOverlay=L.Class.extend({includes:L.Mixin.Events,_el1:null,_el2:null,_elCur:0,_client:null,_map:null,_requestObject:null,options:{format:"PNG",beforeSend:null,bounds:new L.LatLngBounds([[85,-178.965],[-66.5,178.965]]),foregroundProfile:"ajax-fg",backgroundProfile:"ajax-bg"},initialize:function(a,b){if(this._client=a,"object"!=typeof a){if("function"!=typeof XMapClient)throw Error('The XMapClient object is not accessible globally. Have you loaded "xmap-client.js" properly?');this._client=new XMapClient(null,1)}L.Util.setOptions(this,b)},onAdd:function(a){this._map=a,this._el1=L.DomUtil.create("img","leaflet-tile leaflet-zoom-hide"),this._el2=L.DomUtil.create("img","leaflet-tile leaflet-zoom-hide"),this._el1.style.cssText="-webkit-transition: none; -moz-transition: none; -o-transition: opacity 0 linear; transition: none;",this._el2.style.cssText="-webkit-transition: none; -moz-transition: none; -o-transition: opacity 0 linear; transition: none;",this._el1.onload=function(a,b){return function(){a._setActiveEl.call(a,b)}}(this,this._el1),this._el2.onload=function(a,b){return function(){a._setActiveEl.call(a,b)}}(this,this._el2),a.getPanes().overlayPane.appendChild(this._el1),a.getPanes().overlayPane.appendChild(this._el2),a.on({moveend:this._update},this),this._update()},onRemove:function(a){a.off({moveend:this._update},this),a.getPanes().overlayPane.removeChild(this._el1),a.getPanes().overlayPane.removeChild(this._el2)},_setActiveEl:function(a){a===this._el1?(L.DomUtil.addClass(this._el1,"leaflet-tile-loaded"),L.DomUtil.removeClass(this._el2,"leaflet-tile-loaded")):(L.DomUtil.addClass(this._el2,"leaflet-tile-loaded"),L.DomUtil.removeClass(this._el1,"leaflet-tile-loaded"))},_update:function(){var a=this._map.getBounds(),b=this._map.getSize(),c=this._elCur?this._el2:this._el1;if(this._elCur=(this._elCur+1)%2,!(this._map.getZoom()>this._map.getMaxZoom()||this._map.getZoom()<this._map.getMinZoom())){this.options.bounds&&a.clip(this.options.bounds),"function"==typeof this._client.cancelPendingRequests&&this._client.cancelPendingRequests();var d=this._map.project(a.getSouthEast()),e=this._map.project(a.getNorthWest());b.x=Math.max(256,d.x-e.x),b.y=Math.max(256,d.y-e.y);var f=(this._requestTile(a,b,c),this._map.latLngToLayerPoint(a.getNorthWest()));L.DomUtil.setPosition(c,f,!1)}},_getRequestObject:function(){return{mapSection:{leftTop:{$type:"Point",point:{$type:"PlainPoint",x:0,y:0}},rightBottom:{$type:"Point",point:{$type:"PlainPoint",x:0,y:0}}},mapParams:{showScale:!1,useMiles:!1},imageInfo:{format:"",width:0,height:0},layers:[],includeImageInResponse:!0,callerContext:{properties:[{key:"Profile",value:""},{key:"CoordFormat",value:"OG_GEODECIMAL"}]}}},_requestTile:function(a,b,c){var d=this,e=this._map,f=e.options.crs,g=f.project(a.getNorthWest()),h=f.project(a.getSouthEast()),i=new L.LatLngBounds([h.y,g.x],[g.y,h.x]),j=this._getRequestObject();j.mapSection.leftTop.point.x=i.getNorthWest().lng,j.mapSection.leftTop.point.y=i.getNorthWest().lat,j.mapSection.rightBottom.point.x=i.getSouthEast().lng,j.mapSection.rightBottom.point.y=i.getSouthEast().lat,j.imageInfo.format=this.options.format,j.imageInfo.width=b.x,j.imageInfo.height=b.y,"function"==typeof this.options.beforeSend&&(j=this.options.beforeSend(j)),this._client.renderMapBoundingBox(j.mapSection,j.mapParams,j.imageInfo,j.layers,j.includeImageInResponse,j.callerContext,function(a){return function(b,c){d._renderMapCallback.call(d,b,c,a)}}(c)),this.fire("loading")},_renderMapCallback:function(a,b,c){b?(c.src=L.Util.emptyImageUrl,console.log(b.errorMessage)):c.src=L.PtvUtils.createDataURI(a.image.rawImage),this.fire("load",{tile:c,url:c.src})}}),L.PtvLayer=L.PtvLayer||{},L.PtvLayer.Background=L.TileLayer.extend({_client:null,options:{format:"PNG",beforeSend:null,errorTileUrl:"tile-error.png",noWrap:!0,bounds:new L.LatLngBounds([[85,-178.965],[-66.5,178.965]]),minZoom:2,backgroundProfile:"ajax-bg",referenceTime:"",profileSnippet:""},initialize:function(a,b){if(this._client=a,"object"!=typeof a){if("function"!=typeof XMapClient)throw Error('The XMapClient object is not accessible globally. Have you loaded "xmap-client.js" properly?');this._client=new XMapClient(null,5)}L.Util.setOptions(this,b)},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a),"function"==typeof this._client.cancelPendingRequests&&a.on("zoomstart",this._client.cancelPendingRequests)},onRemove:function(a){L.TileLayer.prototype.onAdd.call(this,a),"function"==typeof this._client.cancelPendingRequests&&a.off("zoomstart",this._client.cancelPendingRequests)},_loadTile:function(a,b){a._layer=this,a.onload=this._tileOnLoad,a.onerror=this._tileOnError;this._requestTile(a,b)},_requestTile:function(a,b){var c=this,d=this._map,e=d.options.crs,f=this.options.tileSize,g=this._map.getZoom(),h=b.multiplyBy(f),i=h.add(new L.Point(f,f)),j=e.project(d.unproject(h,g)),k=e.project(d.unproject(i,g)),l=new L.LatLngBounds([k.y,j.x],[j.y,k.x]),m={leftTop:{$type:"Point",point:{$type:"PlainPoint",x:l.getNorthWest().lng,y:l.getNorthWest().lat}},rightBottom:{$type:"Point",point:{$type:"PlainPoint",x:l.getSouthEast().lng,y:l.getSouthEast().lat}}},n={showScale:!1,useMiles:!1,referenceTime:this.options.referenceTime},o={format:this.options.format,width:f,height:f},p=[],q=!0,r={properties:[{key:"Profile",value:this.options.backgroundProfile?this.options.backgroundProfile:"ajax-bg"},{key:"CoordFormat",value:"PTV_MERCATOR"}]};if(""!==this.options.profileSnippet&&r.properties.push({key:"ProfileXMLSnippet",value:this.options.profileSnippet}),"function"==typeof this.options.beforeSend){var s=this.options.beforeSend({mapSection:m,mapParams:n,imageInfo:o,layers:p,includeImageInResponse:q,callerContext:r});m=s.mapSection,n=s.mapParams,o=s.imageInfo,p=s.layers,q=s.includeImageInResponse,r=s.callerContext}var t=function(a){return function(b,d){!d&&b?a.src=L.PtvUtils.createDataURI(b.image.rawImage):(a.src=c.options.errorTileUrl,console.log(d.errorMessage))}}(a);this._client.renderMapBoundingBox(m,n,o,p,q,r,t)}}),L.PtvLayer.background=function(a,b){return new L.PtvLayer.Background(a,b)},L.latLngOrig=L.latLng,L.latLng=function(a,b){return"object"==typeof a&&"x"in a&&"y"in a?new L.LatLng(a.y,a.x):L.latLngOrig(a,b)},L.LatLngBounds.prototype.clip=function(a){a=L.latLngBounds(a),this._southWest.lat=Math.max(a.getSouthWest().lat,this._southWest.lat),this._southWest.lng=Math.max(a.getSouthWest().lng,this._southWest.lng),this._northEast.lat=Math.min(a.getNorthEast().lat,this._northEast.lat),this._northEast.lng=Math.min(a.getNorthEast().lng,this._northEast.lng)},L.PtvLayer=L.PtvLayer||{},L.PtvLayer.Foreground=L.PtvLayer.AbstractOverlay.extend({initialize:function(a,b){L.PtvLayer.AbstractOverlay.prototype.initialize.call(this,a,b)},_getRequestObject:function(){var a=L.PtvLayer.AbstractOverlay.prototype._getRequestObject.call(this);return this.options.language&&(a.mapParams.language=this.options.language),this.options.referenceTime&&""!==this.options.referenceTime&&(a.mapParams.referenceTime=this.options.referenceTime),a.callerContext.properties[0].value=this.options.foregroundProfile?this.options.foregroundProfile:"ajax-fg",a.callerContext.properties[1].value="PTV_MERCATOR",this.options.profileSnippet&&""!==this.options.profileSnippet&&a.callerContext.properties.push({key:"ProfileXMLSnippet",value:this.options.profileSnippet}),a}}),L.PtvLayer.foreground=function(a,b){return new L.PtvLayer.Foreground(a,b)},L.PtvLayer=L.PtvLayer||{},L.PtvLayer.Poi=L.PtvLayer.AbstractOverlay.extend({_layerName:"default.points-of-interest",_profile:"",_condition:"",_formatterFn:null,_poiMarkers:null,initialize:function(a,b){L.PtvLayer.AbstractOverlay.prototype.initialize.call(this,a,b)},onAdd:function(a){L.PtvLayer.AbstractOverlay.prototype.onAdd.call(this,a),this._poiMarkers=L.layerGroup().addTo(a)},onRemove:function(a){L.PtvLayer.AbstractOverlay.prototype.onRemove.call(this,a),a.removeLayer(this._poiMarkers)},_getRequestObject:function(){var a=L.PtvLayer.AbstractOverlay.prototype._getRequestObject.call(this);return a.callerContext.properties[0].value="ajax-av",a.callerContext.properties[1].value="PTV_MERCATOR",a.layers=[{$type:"SMOLayer",name:this._getConfig(),visible:!0,objectInfos:"FULLGEOMETRY",configuration:""}],a},_renderMapCallback:function(a,b,c){if(this._poiMarkers.clearLayers(),L.PtvLayer.AbstractOverlay.prototype._renderMapCallback.call(this,a,b,c),!b&&0!==a.objects.length)for(var d=this.getFormatter(),e=a.objects[0].objects,f=L.divIcon({className:"poi-icon",iconSize:[20,20]}),g=0;g<e.length;g++)latlng=this._map.containerPointToLatLng([e[g].pixel.x,e[g].pixel.y]),L.marker(latlng,{icon:f}).bindPopup(d(e[g].descr)).addTo(this._poiMarkers)},getFormatter:function(){return"function"==typeof this._formatterFn?this._formatterFn:function(a){var b,c;if(a=a.split("#")[1],-1===a.indexOf(":"))b=a;else{var d=a.split(":");b=d[1],c=d[0]}return"<p><strong>"+b.replace("$ยง$","<br/>")+"</strong><br />"+(c?"POI Type: "+c:"")+"</p>"}},setFormatter:function(a){"function"==typeof a&&(this._formatterFn=a)},_getConfig:function(){return this._layerName+(this._profile?"."+this._profile:"")+";"+this._condition},setLayerName:function(a){this._layerName=a,this._update()},getLayerName:function(){return this._layerName},setProfile:function(a){this._profile=a,this._update()},getProfile:function(){return this._profile},setCondition:function(a){this._condition=a,this._update()},getCondition:function(){return this._condition}}),L.PtvLayer.poi=function(a,b){return new L.PtvLayer.Poi(a,b)},L.CRS.PTVMercator=L.extend({},L.CRS,{code:"PTV:MERCATOR",projection:L.Projection.SphericalMercator,transformation:new L.Transformation(.5/Math.PI,.5,-.5/Math.PI,.5),_earthRadius:6371e3,project:function(a){var b=this.projection.project(a);return b.multiplyBy(this._earthRadius)},unproject:function(a){return a=new L.Point(a.x,a.y).divideBy(this._earthRadius),this.projection.unproject(a)}}),L.PtvUtils=L.PtvUtils||{},L.PtvUtils._prefixMap={iVBOR:"data:image/png;base64,",R0lGO:"data:image/gif;base64,","/9j/4":"data:image/jpeg;base64,",Qk02U:"data:image/bmp;base64,"},L.PtvUtils.createDataURI=function(a){return this._prefixMap[a.substr(0,5)]+a};